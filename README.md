## Скрипт рассылки пользователям Telegram
### Базовый функционал и настройки
+ Возможность установить ограничение по числу отправляемых сообщений за 24 часа.
+ Стоп-дублирование сообщений пользователям в случае сбоя скрипта.
+ Возможность задать количество приходящих сообщений за 24 часа конечному пользователю.
+ Возможность задать временной интервал между отправкой сообщений.
+ Поддержка изменения настроек скрипта, а также всех его функциональных файлов без пересборки образа Docker

**Файл с настройками -> settings.py (script/src/settings.py)**
```
...
# Script behavior
MESSAGE_LIMIT_FOR_24H = 1000					# Лимит всех рассылаемых сообщений за 24 часа с аккаунта
NUMBER_MESSAGES_FOR_USER_IN_24H = 2 				# Количество присылаемых сообщений пользователю за 24 часа
SENDING_INTERVAL = 3						# Интервал (в сек) между отправкой сообщений
...
```
### Дополнительно
**Функциональные файлы скрипта -> data.log, date-run.txt, message-text.txt (script/res/)**
+ data.log - запись "битых" никнеймов. Запись тех ников, по которым не удалось отправить сообщения по каким-либо причинам.
+ date-run.txt - файл с временем последнего запуска скрипта. Нужен для проверки. Если необходимо запустить скрипт несколько раз на дню - необходимо изменить дату, желательно больше чем на один день.
+ message-text.txt - файл с текстом рассылки, как и другие функциональные файлы, можно изменить без пересборки образа

### Общее
Скрипт рассылает сообщения только тем пользователям, которые есть в базе данных. Если суточный лимит скрипта больше, чем число пользователей в БД, то сообщения придут всем пользователям (Пример: суточный лимит на отправку - 1000 сообщений, в БД - 550 пользователей, сообщения придут всем этим пользователям  (если таковы не являются "битыми").
Иная ситуация, если число пользователей превышает суточный лимит, в этом случае рассылку получат только определенное количество пользователей, даже если в БД таких намного больше (Пример: суточный лимит на отправку - 800 сообщений, в БД - 973 пользователя, итого получат сообщения только 800 пользователей).
Также скрипт дает возможность задать количество сообщений, приходящих пользователю в сутки. В случае сбоя работы, скрипт не будет заново отправлять сообщения тем пользователям, которые ранее уже их получили. Запуск скрипта возможен раз в сутки, но если нужно запустить несколько раз - необходимо сменить дату последнего запуска в файле (см.выше).

### Инструкция по установке

#### Часть 1
+ Клонируем репозиторий
+ Зайти на официальный сайт Telegram: https://my.telegram.org/auth
+ Авторизовать приложение на сайте по данной ссылке (так как работаем напрямую с API TG) и получить api_hash и api_id.
+ Обязательно ввести эти данные в sign.py (корень проекта) и в файл settings.py (script/src), буквально подставив вместо нулей те значения, которые мы получили.
+ Установить нужные зависимости для запуска отдельного скрипта на локальной машине: 
```
pip3 install TgCrypto Pyrogram
```
+ Перейти в корень проекта и запустить скрипт авторизации аккаунта (sign.py) на локальном компьютере, перед этим установив зависимости *(это обязательно)*.
+ После запуска данного скрипта в консоль ввести номер телефона, на котором есть аккаунт Telegram и куда придет уведомление с кодом. Данный код ввести в консоль. После авторизации нашего приложения, потребность в данном файле отпадает.
+ Рядом с файлом sign.py после успешной авторизации появится файл в формате .session. Он нам и нужен. Копируем/вырезаем, вообщем перемещаем данный файл и переносим в директорию с кодом script/src/ и там сохраняем.
```
mv main.session /home/user/MailingTG/script/src
```
#### Часть 2
+ В корне проекта выполняем:
```
docker-compose build
docker-compose up
```
+ Получив ошибку о том, что нет подключения с БД, переходим к части ее заполнения
```
docker start dbpg-mtg   # если остановился контейнер
docker exec -it dbpg-mtg bash
psql -U postgres
create database users_mtg_db;
\c users_mtg_db
```
+ Cоздадим таблицу с пользователями и заполним данными. Pyrogram принимает как ник, так и телефон, НО, не всегда корректно работает с номерами. Теоретически, это работает более менее стабильно только с теми номерами, которые есть в записной книге.
```
create table users(
nickname text not null unique,
count integer default 0);

insert into users(nickname) values('nickname');
insert into users(nickname) values('+70000000000');
```
+ Перезапустим проект
```
docker-compose up
или
docker restart script-mtg
или
docker exec -it script-mtg bash
python script.py
```

